---
- name: Discover, stop, rollback and start Proxmox VMs
  hosts: proxmox_nodes
  gather_facts: false
  become: true
  vars:
    snapshot_name: "before-k8s"
    vm_name_prefix: "k8s"
    shutdown_timeout: 5

  tasks:
    - name: List all VMs on this node
      ansible.builtin.shell: |
        qm list | awk 'NR>1 {print $1,$2}' | grep "{{ vm_name_prefix }}" || true
      register: vm_list
      changed_when: false

    - name: Parse VM list
      ansible.builtin.set_fact:
        discovered_vms: "{{ vm_list.stdout_lines | map('split', ' ') | map('first') | list }}"
      when: vm_list.stdout | length > 0

    - name: Display discovered VMs on {{ inventory_hostname }}
      ansible.builtin.debug:
        msg: "Found VMs: {{ discovered_vms | default([]) }}"

    - name: Check VM status
      ansible.builtin.command:
        cmd: "qm status {{ item }}"
      loop: "{{ discovered_vms | default([]) }}"
      register: vm_status
      changed_when: false
      failed_when: false

    - name: Stop running VMs (force stop if shutdown times out)
      ansible.builtin.command:
        cmd: "qm shutdown {{ item.item }} --timeout {{ shutdown_timeout }} --forceStop 1"
      loop: "{{ vm_status.results }}"
      when: 
        - item.stdout is defined
        - "'running' in item.stdout"
      register: vm_stop
      failed_when: false

    - name: Wait for VMs to stop
      ansible.builtin.pause:
        seconds: "{{ shutdown_timeout + 2 }}"
      when: vm_stop.changed

    - name: Rollback VMs to snapshot {{ snapshot_name }}
      ansible.builtin.command:
        cmd: "qm rollback {{ item }} {{ snapshot_name }}"
      loop: "{{ discovered_vms | default([]) }}"
      register: rollback_result
      failed_when: rollback_result.rc != 0

    - name: Start VMs after rollback
      ansible.builtin.command:
        cmd: "qm start {{ item.item }}"
      loop: "{{ rollback_result.results }}"
      when: item.rc == 0
      register: vm_start

    - name: Display rollback and start results
      ansible.builtin.debug:
        msg: "VM {{ item.item }} on {{ inventory_hostname }}: Rollback {{ 'SUCCESS' if item.rc == 0 else 'FAILED' }}"
      loop: "{{ rollback_result.results }}"
