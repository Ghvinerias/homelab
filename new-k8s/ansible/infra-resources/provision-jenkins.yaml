---
- name: Deploy Jenkins with Helm
  hosts: localhost
  gather_facts: false
  connection: local
  become: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    kube_context: "" # Set to your context if needed, else leave blank
    deployment_namespace: "ci-cd"
    infisical_host_api: "https://infisical.infra.slick.ge/api"
    identity_id: "998c1306-87ff-4b1e-9225-2f82ef8d5fff"
    project_slug: "infra-resources-b-ou-q"
    env_slug: "homelablocal"
    secrets_path: "/jenkins"
    jenkins_ingress_host: "jenkins.infra.k8s.slick.ge"

  tasks:
    - name: Create ci-cd namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ deployment_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Create InfisicalSecret for Jenkins admin credentials
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: secrets.infisical.com/v1alpha1
          kind: InfisicalSecret
          metadata:
            name: jenkins-admin
            namespace: "{{ deployment_namespace }}"
          spec:
            hostAPI: "{{ infisical_host_api }}"
            resyncInterval: 10
            authentication:
              kubernetesAuth:
                identityId: "{{ identity_id }}"
                serviceAccountRef:
                  name: infisical-service-account
                  namespace: infisical
                secretsScope:
                  envSlug: "{{ env_slug }}"
                  projectSlug: "{{ project_slug }}"
                  secretsPath: "{{ secrets_path }}"
            managedKubeSecretReferences:
              - secretName: jenkins-admin
                secretNamespace: "{{ deployment_namespace }}"
                creationPolicy: Orphan
                template:
                  includeAllSecrets: false
                  data:
                    jenkins-admin-user: "{{ '{{' }} .JENKINS_ADMIN_USER.Value {{ '}}' }}"
                    jenkins-admin-password: "{{ '{{' }} .JENKINS_ADMIN_PASSWORD.Value {{ '}}' }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Wait for jenkins-admin Secret to be created by Infisical
      kubernetes.core.k8s_info:
        kind: Secret
        name: jenkins-admin
        namespace: "{{ deployment_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
      register: jenkins_secret
      until: jenkins_secret.resources | length > 0
      retries: 30
      delay: 10
      failed_when: jenkins_secret.resources | length == 0

    - name: Ensure jenkins Helm repo is present
      kubernetes.core.helm_repository:
        name: jenkins
        repo_url: https://charts.jenkins.io

    - name: Deploy Jenkins via Helm
      kubernetes.core.helm:
        name: jenkins
        chart_ref: jenkins/jenkins
        release_namespace: "{{ deployment_namespace }}"
        create_namespace: true
        values:
          # Jenkins Helm chart values for homelab
          # Chart: jenkins/jenkins
          nameOverride: ""
          fullnameOverride: ""
          
          # Controller (Jenkins Master)
          controller:
            # Admin credentials
            adminUser: admin
            admin:
              existingSecret: jenkins-admin
              userKey: jenkins-admin-user
              passwordKey: jenkins-admin-password
            
            # Service configuration
            serviceType: ClusterIP
            servicePort: 8080
            targetPort: 8080
            
            # Ingress
            ingress:
              enabled: true
              ingressClassName: nginx
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
                kubernetes.io/tls-acme: "true"
              hostName: "{{ jenkins_ingress_host }}"
              paths:
                - path: /
                  pathType: Prefix
              tls:
                - secretName: jenkins-tls
                  hosts:
                    - "{{ jenkins_ingress_host }}"
            
            # Resources
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 4Gi
            
            # JVM options
            javaOpts: "-Xms1g -Xmx2g"
            
            # Jenkins configuration as code
            JCasC:
              defaultConfig: true
              configScripts: {}
            
            # Install plugins on startup
            installPlugins:
              - kubernetes:4203.v1dd44f5b_1cf9
              - workflow-aggregator:596.v8c21c963d92d
              - git:5.2.2
              - configuration-as-code:1810.v9b_c30a_249a_4c
              - prometheus:2.3.1
              - docker-workflow:572.v950f58993843
              - pipeline-stage-view:2.34
              - credentials-binding:677.vdc9d38cb_254d
            
            # Additional plugins (can be customized)
            additionalPlugins: []
            
            # Persistence
            persistence:
              enabled: true
              storageClass: "longhorn"
              size: 50Gi
              accessMode: ReadWriteOnce
            
            # Security context
            securityRealm: |-
              local:
                allowsSignup: false
            
            # Authorization strategy
            authorizationStrategy: |-
              loggedInUsersCanDoAnything:
                allowAnonymousRead: false
          
          # Agent configuration (for running builds)
          agent:
            enabled: true
            defaultsProviderTemplate: ""
            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 2Gi
            
            # Pod retention
            podRetention: "Never"
            
            # Number of executors
            containerCap: 10
          
          # Persistence for workspace (optional)
          persistence:
            enabled: true
            storageClass: "longhorn"
            size: 50Gi
            accessMode: ReadWriteOnce
          
          # Service account
          serviceAccount:
            create: true
            name: jenkins
          
          # RBAC
          rbac:
            create: true
            readSecrets: true

        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
        wait: true
        atomic: true
        update_repo_cache: true
