---
- name: Deploy Loki and Promtail with Helm
  hosts: localhost
  gather_facts: false
  connection: local
  become: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    kube_context: "" # Set to your context if needed, else leave blank
    deployment_namespace: "logging"
    loki_ingress_host: "loki.infra.k8s.slick.ge"
    storage_class: "longhorn"
    storage_size: "5Gi"

  tasks:
    - name: Create logging namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ deployment_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Ensure grafana Helm repo is present
      kubernetes.core.helm_repository:
        name: grafana
        repo_url: https://grafana.github.io/helm-charts

    - name: Deploy Loki via Helm
      kubernetes.core.helm:
        name: loki
        chart_ref: grafana/loki
        release_namespace: "{{ deployment_namespace }}"
        create_namespace: true
        values:
          # Loki configuration for single-instance deployment
          deploymentMode: SingleBinary
          loki:
            auth_enabled: false
            commonConfig:
              replication_factor: 1
              ring:
                kvstore:
                  store: inmemory
            storage:
              type: filesystem
            schemaConfig:
              configs:
                - from: "2024-01-01"
                  store: tsdb
                  object_store: filesystem
                  schema: v13
                  index:
                    prefix: loki_index_
                    period: 24h
            # Retention configuration (adjust as needed)
            limits_config:
              retention_period: 168h # 7 days
              ingestion_rate_mb: 10
              ingestion_burst_size_mb: 20
          
          # Single binary deployment
          singleBinary:
            replicas: 1
            persistence:
              enabled: true
              storageClass: "{{ storage_class }}"
              size: "{{ storage_size }}"
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 1Gi
          
          # Disable components not needed for single binary
          backend:
            replicas: 0
          read:
            replicas: 0
          write:
            replicas: 0
          
          # Disable distributed components
          ingester:
            replicas: 0
          querier:
            replicas: 0
          queryFrontend:
            replicas: 0
          queryScheduler:
            replicas: 0
          distributor:
            replicas: 0
          compactor:
            replicas: 0
          indexGateway:
            replicas: 0
          bloomCompactor:
            replicas: 0
          bloomGateway:
            replicas: 0
          
          # Disable caching components
          memcached:
            enabled: false
          memcachedExporter:
            enabled: false
          memcachedChunks:
            enabled: false
          memcachedFrontend:
            enabled: false
          memcachedIndexQueries:
            enabled: false
          memcachedIndexWrites:
            enabled: false
          resultsCache:
            enabled: false
          chunksCache:
            enabled: false
          
          # Gateway configuration
          gateway:
            enabled: true
            replicas: 1
            service:
              type: ClusterIP
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
          
          # Monitoring
          monitoring:
            selfMonitoring:
              enabled: false
              grafanaAgent:
                installOperator: false
            serviceMonitor:
              enabled: true
              labels:
                release: kube-prometheus-stack
            lokiCanary:
              enabled: false
          
          # Disable memberlist (not needed for single binary)
          memberlist:
            service:
              publishNotReadyAddresses: false
          
          # Test configuration
          test:
            enabled: false
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Deploy Promtail for log collection
      kubernetes.core.helm:
        name: promtail
        chart_ref: grafana/promtail
        release_namespace: "{{ deployment_namespace }}"
        create_namespace: true
        values:
          config:
            clients:
              - url: http://loki-gateway.{{ deployment_namespace }}.svc.cluster.local/loki/api/v1/push
                tenant_id: homelab
            
            # Scrape configuration for Kubernetes pods
            snippets:
              scrapeConfigs: |
                - job_name: kubernetes-pods
                  pipeline_stages:
                    - cri: {}
                  kubernetes_sd_configs:
                    - role: pod
                  relabel_configs:
                    - source_labels:
                        - __meta_kubernetes_pod_controller_name
                      regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
                      action: replace
                      target_label: __tmp_controller_name
                    - source_labels:
                        - __meta_kubernetes_pod_label_app_kubernetes_io_name
                        - __meta_kubernetes_pod_label_app
                        - __tmp_controller_name
                        - __meta_kubernetes_pod_name
                      regex: ^;*([^;]+)(;.*)?$
                      action: replace
                      target_label: app
                    - source_labels:
                        - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                        - __meta_kubernetes_pod_label_instance
                      regex: ^;*([^;]+)(;.*)?$
                      action: replace
                      target_label: instance
                    - source_labels:
                        - __meta_kubernetes_pod_label_app_kubernetes_io_component
                        - __meta_kubernetes_pod_label_component
                      regex: ^;*([^;]+)(;.*)?$
                      action: replace
                      target_label: component
                    - action: replace
                      source_labels:
                      - __meta_kubernetes_pod_node_name
                      target_label: node_name
                    - action: replace
                      source_labels:
                      - __meta_kubernetes_namespace
                      target_label: namespace
                    - action: replace
                      replacement: $1
                      separator: /
                      source_labels:
                      - namespace
                      - app
                      target_label: job
                    - action: replace
                      source_labels:
                      - __meta_kubernetes_pod_name
                      target_label: pod
                    - action: replace
                      source_labels:
                      - __meta_kubernetes_pod_container_name
                      target_label: container
                    - action: replace
                      replacement: /var/log/pods/*$1/*.log
                      separator: /
                      source_labels:
                      - __meta_kubernetes_pod_uid
                      - __meta_kubernetes_pod_container_name
                      target_label: __path__
                    - action: replace
                      regex: true/(.*)
                      replacement: /var/log/pods/*$1/*.log
                      separator: /
                      source_labels:
                      - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
                      - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
                      - __meta_kubernetes_pod_container_name
                      target_label: __path__
          
          # DaemonSet configuration to run on all nodes
          daemonset:
            enabled: true
          
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          
          # Service Monitor for Prometheus
          serviceMonitor:
            enabled: true
            labels:
              release: kube-prometheus-stack
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Create Ingress for Loki Gateway
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: loki-gateway
            namespace: "{{ deployment_namespace }}"
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
          spec:
            ingressClassName: nginx
            tls:
              - hosts:
                  - "{{ loki_ingress_host }}"
                secretName: loki-gateway-tls
            rules:
              - host: "{{ loki_ingress_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: loki-gateway
                          port:
                            number: 80
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Wait for Loki StatefulSet to be ready
      kubernetes.core.k8s_info:
        kind: StatefulSet
        namespace: "{{ deployment_namespace }}"
        name: loki
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
      register: loki_statefulset
      until: loki_statefulset.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Wait for Promtail DaemonSet to be ready
      kubernetes.core.k8s_info:
        kind: DaemonSet
        namespace: "{{ deployment_namespace }}"
        name: promtail
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
      register: promtail_daemonset
      until: promtail_daemonset.resources[0].status.numberReady | default(0) >= 1
      retries: 30
      delay: 10

    - name: Display deployment information
      debug:
        msg:
          - "âœ… Loki deployed successfully!"
          - ""
          - "ğŸ“Š Access Information:"
          - "  - Loki Gateway: http://loki-gateway.{{ deployment_namespace }}.svc.cluster.local"
          - "  - Loki Ingress: https://{{ loki_ingress_host }}"
          - "  - Promtail collecting logs from all pods"
          - ""
          - "ğŸ” Configure Grafana Data Source:"
          - "  - URL: http://loki-gateway.{{ deployment_namespace }}.svc.cluster.local"
          - "  - Type: Loki"
          - ""
          - "ğŸ“ Retention: 7 days (168h)"
          - "ğŸ’¾ Storage: {{ storage_size }} on {{ storage_class }}"
