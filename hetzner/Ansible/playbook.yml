---
- name: Install Kubernetes on 4-node cluster
  hosts: k8s_cluster
  become: true

  roles:
    - geerlingguy.containerd
    - rothman857.kubernetes

  vars:
    # Kubernetes version
    kubernetes_version: "1.32"
    kubernetes_version_rhel_package: "1.32"

    # Pod network configuration
    kubernetes_pod_network:
      cni: "flannel"
      cidr: "10.244.0.0/16"

    # Kubelet configuration (recommended method)
    kubernetes_config_kubelet_configuration:
      cgroupDriver: systemd

    # Cluster configuration
    kubernetes_config_cluster_configuration:
      networking:
        podSubnet: "{{ kubernetes_pod_network.cidr }}"
      kubernetesVersion: "stable-{{ kubernetes_version }}"

    # Init configuration
    kubernetes_config_init_configuration:
      localAPIEndpoint:
        advertiseAddress: "{{ ansible_default_ipv4.address }}"

    # Don't allow pods on control plane (set to true for single-node)
    kubernetes_allow_pods_on_control_plane: false

    # Ignore preflight errors if needed
    kubernetes_ignore_preflight_errors: "NumCPU,Mem"

- name: Set control plane role
  hosts: control_plane
  become: true
  vars:
    kubernetes_role: control_plane

- name: Set node role
  hosts: nodes
  become: true
  vars:
    kubernetes_role: node
