---
- name: Deploy Kubernetes resources with Helm and kubectl
  hosts: localhost
  gather_facts: false
  connection: local
  become: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    kube_context: "" # Set to your context if needed, else leave blank
    ingress_nginx_values: "{{ lookup('file', '../../k8s/nle/ingress-nginx-monitoring-values.yaml') }}"
    cluster_issuer_yaml: "{{ lookup('file', '../../k8s/nle/clusterIssuer.yaml') }}"

  tasks:
    - name: Ensure ingress-nginx Helm repo is present
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx

    - name: Ensure cert-manager (jetstack) Helm repo is present
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: https://charts.jetstack.io

    - name: Ensure longhorn Helm repo is present
      kubernetes.core.helm_repository:
        name: longhorn
        repo_url: https://charts.longhorn.io

    # Repository cache will be updated during install/upgrade via update_repo_cache

    - name: Deploy ingress-nginx via Helm
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        values: "{{ ingress_nginx_values | from_yaml }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
        wait: true
        atomic: true
        update_repo_cache: true

    - name: Deploy cert-manager via Helm (with CRDs)
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        set_values:
          - value: crds.enabled=true
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
        wait: true
        atomic: true
        update_repo_cache: true

    - name: Deploy longhorn via Helm
      kubernetes.core.helm:
        name: longhorn
        chart_ref: longhorn/longhorn
        release_namespace: longhorn-system
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
        wait: true
        atomic: true
        update_repo_cache: true

    - name: Wait for cert-manager CRDs to be available
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: clusterissuers.cert-manager.io
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
      register: crd_info
      retries: 10
      delay: 10
      until: crd_info.resources | length > 0

    - name: Apply ClusterIssuer YAML
      kubernetes.core.k8s:
        state: present
        definition: "{{ cluster_issuer_yaml | from_yaml }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
