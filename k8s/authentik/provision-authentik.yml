---
- name: Deploy Kubernetes resources with Helm and kubectl
  hosts: localhost
  gather_facts: false
  connection: local
  become: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    kube_context: "" # Set to your context if needed, else leave blank
    ingress_nginx_values: "{{ lookup('file', './values.yaml') }}"

  tasks:
    - name: Deploy Bitwarden secrets configuration
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', './deploy-bws-secrets.yaml') | from_yaml_all | list }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"

    - name: Wait for external secrets to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: authentik-secrets
        namespace: authentik
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
      register: secret_status
      until: secret_status.resources | length > 0
      retries: 30
      delay: 10

    - name: Ensure authentik Helm repo is present
      kubernetes.core.helm_repository:
        name: authentik
        repo_url: https://charts.goauthentik.io

    # Repository cache will be updated during install/upgrade via update_repo_cache

    - name: Deploy authentik via Helm
      kubernetes.core.helm:
        name: authentik
        chart_ref: authentik/authentik
        release_namespace: authentik
        create_namespace: true
        values: "{{ ingress_nginx_values | from_yaml }}"
        kubeconfig: "{{ kubeconfig }}"
        context: "{{ kube_context if kube_context else omit }}"
        wait: true
        atomic: true
        update_repo_cache: true
